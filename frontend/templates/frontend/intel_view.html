{% extends 'frontend/base.html' %}
{% load static %}
{% load martortags %}

{% block page_title %}#{{ intel.id }} - {{ intel.title }}{% endblock %}

{% block page_content %}
    <div class="content">

        {#  TAGS #}
        <div>
            <p>
                {% for tag in intel.tags.all %}
                    <span class="badge badge-primary">{{ tag.name }}</span>
                {% endfor %}
            </p>
        </div>

        <div class="row">
            <div class="col-md-8">
                {# BASIC INFO #}
                <div class="block">
                    <div class="block-header">
                        <h3 class="block-title">
                            Basic information
                        </h3>
                    </div>

                    <div class="block-content">
                        <ul>
                            <li>
                                <strong>Author:</strong>
                                {{ intel.author.username }}
                            </li>

                            <li>
                                <strong>Resource Type:</strong>
                                {{ intel.resource_type |capfirst }}
                            </li>

                            <li>
                                <strong>Creation date:</strong>
                                {{ intel.creation_date }}
                            </li>

                            <li>
                                <strong>Last update:</strong>
                                {{ intel.last_update }}
                            </li>

                            <li>
                                <strong>Link:</strong>
                                {% if intel.link %}
                                    <a href="{{ intel.link }}">{{ intel.link |truncatechars:100 }}</a>
                                {% else %}
                                    <i>null</i>
                                {% endif %}
                            </li>

                            <li>
                                <strong>Note:</strong>
                                {% if intel.additional_note %}
                                    <p>{{ intel.additional_note }}</p>
                                {% else %}
                                    <i>null</i>
                                {% endif %}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            {# FILES #}
            <div class="col-md-4">
                <div class="block" style="overflow: auto; max-height: 270px">
                    <div class="block-header">
                        <h3 class="block-title">
                            Files (<span id="id_file_count">{{ intel.files.count }}</span>)
                        </h3>
                        <div class="block-options">
                            <button type="button" class="btn-block-option js-upload-photos">
                                <i class="si si-cloud-upload"></i>
                            </button>

                            <input id="fileupload" type="file" name="file" multiple
                                   style="display: none;"
                                   data-url="{% url 'intelfiles-list' %}"
                                   data-form-data='{"csrfmiddlewaretoken": "{{ csrf_token }}", "intel":{{ intel.id }}}'>

                        </div>
                    </div>
                    <div class="block-content">
                        {% if not intel.files %}
                            <p><i>No files</i></p>
                        {% else %}
                            <ul id="id_files_ul">
                                {% for intelfile in intel.files.all %}
                                    <li><a href="{{ intelfile.file.url }}" target="_blank">{{ intelfile.filename }}</a></li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            </div>

        </div>

        {#  control panel #}
        <div class="block">
            <div class="block-header">
                <h3 class="block-title">Control</h3>
            </div>

            <div class="block-content">
                <!-- Default -->
                <div class="mb-4">
                    <button type="button" class="btn btn-info mr-1 mb-3" onclick="window.location.href='{% url 'update' pk=intel.id %}'">
                        <i class="fa fa-fw fa-pen mr-1"></i> Update
                    </button>

                    <div style="display: inline-block">
                        {% if intel.link %}
                            <form method="post" action="{% url 'bookmark_add'  %}">
                                {% csrf_token %}
                                <input type="hidden" name="intel_id" value="{{ intel.id }}">
                                <button type="submit" class="btn btn-secondary mr-1 mb-3">
                                    <i class="fa fa-fw fa-camera mr-1"></i> Snapshot
                                </button>
                            </form>
                        {% else %}
                            <button type="button" class="btn btn-secondary mr-1 mb-3 disabled" data-toggle="tooltip" data-placement="top" title="No link provided">
                                <i class="fa fa-fw fa-camera mr-1"></i> Snapshot
                            </button>
                        {% endif %}
                    </div>

                    <button type="button" class="btn btn-danger mr-1 mb-3" onclick="window.location.href='{% url 'delete' pk=intel.id %}'">
                        <i class="fa fa-fw fa-times mr-1"></i> Delete
                    </button>
                </div>
                <!-- END Default -->
            </div>
        </div>


        {#  TEXT CONTENT #}
        <div class="block">
            <div class="block-header">
                <h3 class="block-title">
                    Text content
                </h3>
            </div>
            <div class="block-content">
                {% if intel.text_content %}
                    <p>{{ intel.text_content | safe_markdown }}</p>
                {% else %}
                    <p><i>null</i></p>
                {% endif %}
            </div>
        </div>

    </div>

    {# Progress bar modal #}
    <div class="modal" id="modal-progress">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Uploading...</h4>
                </div>
                <div class="modal-body">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block custom_js %}
    {# JQUERY FILE UPLOAD SCRIPTS #}
    <script src="{% static 'frontend/assets/js/plugins/jquery-file-upload/vendor/jquery.ui.widget.js' %}"></script>
    <script src="{% static 'frontend/assets/js/plugins/jquery-file-upload/jquery.iframe-transport.js' %}"></script>
    <script src="{% static 'frontend/assets/js/plugins/jquery-file-upload/jquery.fileupload.js' %}"></script>

    <script>
        function add_to_files_list(file_url) {
            let filename = file_url.substring(file_url.lastIndexOf('/')+1);
            let files_count = parseInt($("#id_file_count").text());
            if (files_count === 0) {
                $("#id_files_ul").html('<ul id="id_files_ul"></ul>')
            }
            let entry = `<li><a href="${file_url}" target="_blank">${filename}</a></li>`;
            $("#id_files_ul").append(entry);
            $("#id_file_count").html(files_count+1);
        }


            $( document ).ready(function() {

                  $(".js-upload-photos").click(function () {
                    $("#fileupload").click();
                  });

                  // init file upload
                $("#fileupload").fileupload({
                    dataType: 'json',
                    sequentialUploads: true,  /* 1. SEND THE FILES ONE BY ONE */
                    start: function (e) {  /* 2. WHEN THE UPLOADING PROCESS STARTS, SHOW THE MODAL */
                      $("#modal-progress").modal("show");
                    },
                    stop: function (e) {  /* 3. WHEN THE UPLOADING PROCESS FINALIZE, HIDE THE MODAL */
                      $("#modal-progress").modal("hide");

                    },
                    progressall: function (e, data) {  /* 4. UPDATE THE PROGRESS BAR */
                      var progress = parseInt(data.loaded / data.total * 100, 10);
                      var strProgress = progress + "%";
                      $(".progress-bar").css({"width": strProgress});
                      $(".progress-bar").text(strProgress);
                    },
                    done: function (e, data) {
                        console.log(data);
                        add_to_files_list(data.result.file)
                    }
                  });

        });


    </script>
{% endblock %}