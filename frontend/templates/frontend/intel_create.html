{% extends 'frontend/base.html' %}
{% load static %}
{% load rest_framework %}

{% block page_title %}Add intel{% endblock %}

{% block page_content %}
<div class="content">
    <div class="block">
            <div class="block-header">
                <h3 class="block-title">Labels on top</h3>
            </div>
            <div class="block-content block-content-full">
                <div class="row">
                    <div class="col-lg-4">
                        <p class="font-size-sm text-muted">
                            An often used layout which is very easy to create with minimal markup
                        </p>
                    </div>
                    <div class="col-lg-8">
                        <!-- Form Labels on top - Default Style -->
                        <form action="{% url 'intels-list' %}" method="POST" id="id_create_form">
                            {% csrf_token %}
                            {% render_form intel_serializer %}
                            <input type="submit" value="Save">
                        </form>
                        <!-- END Form Labels on top - Default Style -->

                        <div>
                            <button type="button" class="btn btn-primary js-upload-photos" id="id_upload_btn">
                              <span class="glyphicon glyphicon-cloud-upload"></span> Upload photos
                            </button>

                            <div class="well text-muted text-center" style="padding-top: 4rem; padding-bottom: 4rem;">
                              <span class="glyphicon glyphicon-arrow-down" style="font-size: 4rem;"></span>
                              <h3>Drop Photos Here to Upload</h3>
                            </div>

                            <input id="fileupload" type="file" name="file" multiple
                                   style="display: none;"
                                   data-url="{% url 'intelfiles-list' %}"
                                   data-form-data='{"csrfmiddlewaretoken": "{{ csrf_token }}", "intel":1}'>

                            <table id="id_files_table" class="table table-bordered">
                              <thead>
                                <tr>
                                    <th>File</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                </tr>
                              </thead>
                              <tbody>
                              </tbody>
                            </table>
                        </div>
                        <div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    {# Progress bar modal #}
    <div class="modal" id="modal-progress">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Uploading...</h4>
                </div>
                <div class="modal-body">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}

    <script src="{% static 'frontend/assets/js/plugins/jquery-file-upload/vendor/jquery.ui.widget.js' %}"></script>
    <script src="{% static 'frontend/assets/js/plugins/jquery-file-upload/jquery.iframe-transport.js' %}"></script>
    <script src="{% static 'frontend/assets/js/plugins/jquery-file-upload/jquery.fileupload.js' %}"></script>


    <script src="{% static "frontend/assets/javascript/create.js" %}"></script>

    <script>
        $( document ).ready(function() {

            // init intel creation
            var api_endpoint = "{% url 'intels-list' %}";
            $("#id_create_form").on("submit", function (e) {
                e.preventDefault();
                create_intel(api_endpoint, $(this).serialize());
            });

            // init file upload
            $("#fileupload").fileupload({
                dataType: 'json',
                sequentialUploads: true,  /* 1. SEND THE FILES ONE BY ONE */
                add: function (e, data) {
                    data.files.forEach(function (f) { add_file_to_table(f)});
                    $("#id_upload_btn").off('click').on('click', function () {
                        data.submit();
                    });
                },
                start: function (e) {  /* 2. WHEN THE UPLOADING PROCESS STARTS, SHOW THE MODAL */
                  $("#modal-progress").modal("show");
                },
                stop: function (e) {  /* 3. WHEN THE UPLOADING PROCESS FINALIZE, HIDE THE MODAL */
                  $("#modal-progress").modal("hide");
                },
                progressall: function (e, data) {  /* 4. UPDATE THE PROGRESS BAR */
                  var progress = parseInt(data.loaded / data.total * 100, 10);
                  var strProgress = progress + "%";
                  $(".progress-bar").css({"width": strProgress});
                  $(".progress-bar").text(strProgress);
                },
                done: function (e, data) {
                    console.log("upload ok");
                }
              });

        });
    </script>
{% endblock %}